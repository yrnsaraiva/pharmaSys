{% extends 'main.html' %}
{% load static %}

{% block content %}
    {% include 'navbar.html' %}

    <div class="flex">
        <div class="flex-1 ml-64 p-8" id="main-content">
            <!-- Cabeçalho -->
            <div class="flex justify-between items-center mb-8" id="page-header">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Relatórios Avançados</h2>
                    <p class="text-gray-600">Análise de dados e métricas do negócio</p>
                </div>
            </div>

            <!-- Filtros -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6" id="filters-section">
                <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div id="report-type">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Relatório</label>
                        <select name="tipo_relatorio"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            {% for valor, label in tipos_relatorio %}
                                <option value="{{ valor }}" {% if tipo_relatorio == valor %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="start-date">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Início</label>
                        <input name="data_inicio" value="{{ data_inicio }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               type="date">
                    </div>
                    <div id="end-date">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Fim</label>
                        <input name="data_fim" value="{{ data_fim }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               type="date">
                    </div>
                    <div id="attendant-filter">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Atendente</label>
                        <select name="atendente"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="">Todos os atendentes</option>
                            {% for atendente in atendentes %}
                                <option value="{{ atendente.id }}" {% if atendente_selecionado == atendente.id|stringformat:"i" %}selected{% endif %}>
                                    {{ atendente.get_full_name|default:atendente.username }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="md:col-span-4 flex justify-end mt-4">
                        <button type="submit"
                                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-chart-bar mr-2"></i>
                            Gerar Relatório
                        </button>
                    </div>
                </form>
            </div>

            <!-- Estatísticas Rápidas -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div class="text-sm text-blue-600 font-medium">Total de Vendas</div>
                    <div class="text-2xl font-bold text-blue-800">{{ total_vendas }}</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <div class="text-sm text-green-600 font-medium">Faturamento Total</div>
                    <div class="text-2xl font-bold text-green-800">{{ faturamento_total|floatformat:2 }} MT</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                    <div class="text-sm text-purple-600 font-medium">Lucro Total</div>
                    <div class="text-2xl font-bold text-purple-800">{{ lucro_total|floatformat:2 }} MT</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <div class="text-sm text-yellow-600 font-medium">Margem de Lucro</div>
                    <div class="text-2xl font-bold text-yellow-800">{{ margem_lucro|floatformat:1 }}%</div>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Gráfico Principal -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6" id="sales-chart-container">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4" id="main-chart-title">
                        {% if tipo_relatorio == 'sales' %}Vendas por Período
                        {% elif tipo_relatorio == 'bestsellers' %}Produtos Mais Vendidos
                        {% elif tipo_relatorio == 'deadstock' %}Estoque Parado
                        {% elif tipo_relatorio == 'profitability' %}Rentabilidade por Período
                        {% else %}Gráfico Principal{% endif %}
                    </h3>
                    <div class="h-64" id="sales-chart">
                        <div class="flex items-center justify-center h-full text-gray-500">
                            Carregando gráfico...
                        </div>
                    </div>
                </div>

                <!-- Gráfico Secundário -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6" id="profit-chart-container">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4" id="secondary-chart-title">
                        {% if tipo_relatorio == 'sales' %}Rentabilidade por Categoria
                        {% elif tipo_relatorio == 'bestsellers' %}Categorias Mais Vendidas
                        {% elif tipo_relatorio == 'deadstock' %}Categorias com Estoque Parado
                        {% elif tipo_relatorio == 'profitability' %}Rentabilidade por Categoria
                        {% else %}Gráfico Secundário{% endif %}
                    </h3>
                    <div class="h-64" id="profit-chart">
                        <div class="flex items-center justify-center h-full text-gray-500">
                            Carregando gráfico...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela de Relatórios -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden"
                 id="report-table-container">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900" id="table-title">
                        {% if tipo_relatorio == 'sales' %}Vendas por Período - {{ data_inicio }} a {{ data_fim }}
                        {% elif tipo_relatorio == 'bestsellers' %}Produtos Mais Vendidos - {{ data_inicio }} a {{ data_fim }}
                        {% elif tipo_relatorio == 'deadstock' %}Estoque Parado
                        {% elif tipo_relatorio == 'profitability' %}Rentabilidade - {{ data_inicio }} a {{ data_fim }}
                        {% else %}Relatório - {{ data_inicio }} a {{ data_fim }}{% endif %}
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                        <tr>
                            {% if tipo_relatorio == 'sales' or tipo_relatorio == 'profitability' %}
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Data</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Vendas (MT)</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Custo (MT)</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Lucro (MT)</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Margem</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Atendente</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Status</th>
                            {% elif tipo_relatorio == 'bestsellers' %}
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Produto</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Categoria</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Quantidade</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Faturamento (MT)</th>
                            {% elif tipo_relatorio == 'deadstock' %}
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Produto</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Categoria</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Estoque Atual</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Estoque Mínimo</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Última Venda</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Dias Sem Venda</th>
                            {% endif %}
                        </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                        {% for linha in dados_tabela %}
                        <tr class="hover:bg-gray-50 transition-colors">
                            {% if tipo_relatorio == 'sales' or tipo_relatorio == 'profitability' %}
                                <td class="px-6 py-4 text-sm text-gray-900">{{ linha.data }}</td>
                                <td class="px-6 py-4 text-sm font-medium text-gray-900">{{ linha.vendas|floatformat:2 }}</td>
                                <td class="px-6 py-4 text-sm text-gray-600">{{ linha.custo|floatformat:2 }}</td>
                                <td class="px-6 py-4 text-sm font-medium text-green-600">{{ linha.lucro|floatformat:2 }}</td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                        {% if linha.status_cor == 'green' %}bg-green-100 text-green-800
                                        {% elif linha.status_cor == 'yellow' %}bg-yellow-100 text-yellow-800
                                        {% else %}bg-red-100 text-red-800{% endif %}">
                                        {{ linha.margem|floatformat:1 }}%
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-900">{{ linha.atendente }}</td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                        {% if linha.status_cor == 'green' %}bg-green-100 text-green-800
                                        {% elif linha.status_cor == 'yellow' %}bg-yellow-100 text-yellow-800
                                        {% else %}bg-red-100 text-red-800{% endif %}">
                                        {{ linha.status }}
                                    </span>
                                </td>
                            {% elif tipo_relatorio == 'bestsellers' %}
                                <td class="px-6 py-4 text-sm font-medium text-gray-900">{{ linha.produto }}</td>
                                <td class="px-6 py-4 text-sm text-gray-600">{{ linha.categoria }}</td>
                                <td class="px-6 py-4 text-sm text-blue-600 font-medium">{{ linha.quantidade }}</td>
                                <td class="px-6 py-4 text-sm font-medium text-green-600">{{ linha.faturamento|floatformat:2 }}</td>
                            {% elif tipo_relatorio == 'deadstock' %}
                                <td class="px-6 py-4 text-sm font-medium text-gray-900">{{ linha.produto }}</td>
                                <td class="px-6 py-4 text-sm text-gray-600">{{ linha.categoria }}</td>
                                <td class="px-6 py-4 text-sm font-medium {% if linha.estoque_atual > linha.estoque_minimo %}text-green-600{% else %}text-red-600{% endif %}">
                                    {{ linha.estoque_atual }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600">{{ linha.estoque_minimo }}</td>
                                <td class="px-6 py-4 text-sm text-gray-600">{{ linha.ultima_venda }}</td>
                                <td class="px-6 py-4 text-sm font-medium text-red-600">{{ linha.dias_sem_venda }}</td>
                            {% endif %}
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{% if tipo_relatorio == 'sales' or tipo_relatorio == 'profitability' %}7{% elif tipo_relatorio == 'bestsellers' %}4{% elif tipo_relatorio == 'deadstock' %}6{% else %}7{% endif %}"
                                class="px-6 py-8 text-center text-gray-500">
                                Nenhum dado encontrado para o período selecionado
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if tipo_relatorio == 'sales' or tipo_relatorio == 'profitability' %}
                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">Total do período:</span>
                        <div class="flex space-x-6">
                            <span class="font-medium text-gray-900">Vendas: {{ faturamento_total|floatformat:2 }} MT</span>
                            <span class="font-medium text-gray-900">Custo: {{ custo_total|floatformat:2 }} MT</span>
                            <span class="font-medium text-green-600">Lucro: {{ lucro_total|floatformat:2 }} MT</span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Incluir Highcharts -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <script>
    // Dados dos gráficos
    const dadosVendas = {{ dados_grafico_vendas|safe }};
    const dadosRentabilidade = {{ dados_grafico_rentabilidade|safe }};
    const tipoRelatorio = "{{ tipo_relatorio }}";

    // Configurações de gráfico por tipo
    const chartConfigs = {
        'sales': {
            main: { type: 'column', title: 'Vendas por Período', yTitle: 'Vendas (MT)' },
            secondary: { type: 'pie', title: 'Rentabilidade por Categoria' }
        },
        'bestsellers': {
            main: { type: 'column', title: 'Produtos Mais Vendidos', yTitle: 'Quantidade Vendida' },
            secondary: { type: 'pie', title: 'Categorias Mais Vendidas' }
        },
        'deadstock': {
            main: { type: 'column', title: 'Estoque Parado', yTitle: 'Quantidade em Estoque' },
            secondary: { type: 'pie', title: 'Categorias com Estoque Parado' }
        },
        'profitability': {
            main: { type: 'line', title: 'Rentabilidade por Período', yTitle: 'Valor (MT)' },
            secondary: { type: 'pie', title: 'Rentabilidade por Categoria' }
        }
    };

    // Função para inicializar gráficos
    function inicializarGraficos() {
        try {
            const config = chartConfigs[tipoRelatorio] || chartConfigs['sales'];

            // Gráfico Principal
            if (dadosVendas && dadosVendas.categories && dadosVendas.series) {
                Highcharts.chart('sales-chart', {
                    chart: { type: config.main.type, height: 256 },
                    title: { text: null },
                    xAxis: { categories: dadosVendas.categories, crosshair: true },
                    yAxis: { min: 0, title: { text: config.main.yTitle } },
                    tooltip: { valuePrefix: tipoRelatorio === 'sales' ? 'MT ' : '' },
                    series: dadosVendas.series,
                    exporting: { enabled: false },
                    credits: { enabled: false }
                });
            } else {
                document.getElementById('sales-chart').innerHTML =
                    '<div class="flex items-center justify-center h-full text-gray-500">Dados não disponíveis</div>';
            }

            // Gráfico Secundário
            if (dadosRentabilidade && dadosRentabilidade.series) {
                Highcharts.chart('profit-chart', {
                    chart: { type: config.secondary.type, height: 256 },
                    title: { text: null },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '<b>{point.name}</b>: {point.y:.2f}' + (tipoRelatorio === 'sales' ? ' MT' : '')
                            }
                        }
                    },
                    tooltip: {
                        pointFormat: '{series.name}: <b>{point.y:.2f}</b>' + (tipoRelatorio === 'sales' ? ' MT' : '')
                    },
                    series: dadosRentabilidade.series,
                    exporting: { enabled: false },
                    credits: { enabled: false }
                });
            } else {
                document.getElementById('profit-chart').innerHTML =
                    '<div class="flex items-center justify-center h-full text-gray-500">Dados não disponíveis</div>';
            }

        } catch (error) {
            console.error('Erro ao carregar gráficos:', error);
            document.getElementById('sales-chart').innerHTML =
                '<div class="flex items-center justify-center h-full text-red-500">Erro ao carregar gráfico</div>';
            document.getElementById('profit-chart').innerHTML =
                '<div class="flex items-center justify-center h-full text-red-500">Erro ao carregar gráfico</div>';
        }
    }

    // Inicializar gráficos quando a página carregar
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializarGraficos);
    } else {
        inicializarGraficos();
    }

    // Mostrar loading ao submeter formulário
    document.querySelector('form').addEventListener('submit', function() {
        document.getElementById('sales-chart').innerHTML =
            '<div class="flex items-center justify-center h-full text-gray-500">Carregando...</div>';
        document.getElementById('profit-chart').innerHTML =
            '<div class="flex items-center justify-center h-full text-gray-500">Carregando...</div>';
    });
    </script>

    <style>
        @media print {
            .flex { display: block !important; }
            .ml-64 { margin-left: 0 !important; }
            #filters-section { display: none !important; }
            .bg-white { background: white !important; }
            .shadow-sm { box-shadow: none !important; }
        }
    </style>

{% endblock %}