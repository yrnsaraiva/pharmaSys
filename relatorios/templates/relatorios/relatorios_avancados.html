{% extends 'main.html' %}
{% load static %}

{% block content %}

    {% include 'navbar.html' %}

    <div class="flex">
        <div class="flex-1 ml-64 p-8" id="main-content">
            <!-- Cabeçalho -->
            <div class="flex justify-between items-center mb-8" id="page-header">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Relatórios</h2>
                    <p class="text-gray-600">Análise de dados e métricas do negócio</p>
                </div>

            </div>

            <!-- Filtros -->
            <div class="bg-white rounded-lg shadow-sm border border-pharmacy-gray p-6 mb-6" id="filters-section">
                <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div id="report-type">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Relatório</label>
                        <select name="tipo_relatorio"
                                class="w-full px-4 py-2 border border-pharmacy-gray rounded-lg focus:ring-2 focus:ring-pharmacy-green focus:border-transparent">
                            {% for valor, label in tipos_relatorio %}
                                <option value="{{ valor }}" {% if tipo_relatorio == valor %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="start-date">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Início</label>
                        <input name="data_inicio" value="{{ data_inicio }}"
                               class="w-full px-4 py-2 border border-pharmacy-gray rounded-lg focus:ring-2 focus:ring-pharmacy-green focus:border-transparent"
                               type="date">
                    </div>
                    <div id="end-date">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data Fim</label>
                        <input name="data_fim" value="{{ data_fim }}"
                               class="w-full px-4 py-2 border border-pharmacy-gray rounded-lg focus:ring-2 focus:ring-pharmacy-green focus:border-transparent"
                               type="date">
                    </div>
                    <div id="attendant-filter">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Atendente</label>
                        <select name="atendente"
                                class="w-full px-4 py-2 border border-pharmacy-gray rounded-lg focus:ring-2 focus:ring-pharmacy-green focus:border-transparent">
                            <option value="">Todos os atendentes</option>
                            {% for atendente in atendentes %}
                                <option value="{{ atendente.id }}" {% if atendente_selecionado == atendente.id|stringformat:"i" %}selected{% endif %}>
                                    {{ atendente.username }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="md:col-span-4 flex justify-end mt-4">
                        <button type="submit"
                                class="bg-pharmacy-green hover:bg-pharmacy-green-dark text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            <i class="mr-2">
                                <svg aria-hidden="true" class="w-4 h-4 inline" data-icon="magnifying-glass"
                                     data-prefix="fas" focusable="false" role="img" viewBox="0 0 512 512"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"
                                          fill="currentColor"></path>
                                </svg>
                            </i>
                            Gerar Relatório
                        </button>
                    </div>
                </form>
            </div>

            <!-- Estatísticas Rápidas -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div class="text-sm text-blue-600 font-medium">Total de Vendas</div>
                    <div class="text-2xl font-bold text-blue-800">{{ total_vendas }}</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <div class="text-sm text-green-600 font-medium">Faturamento Total</div>
                    <div class="text-2xl font-bold text-green-800">{{ faturamento_total|floatformat:2 }} MT</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                    <div class="text-sm text-purple-600 font-medium">Lucro Total</div>
                    <div class="text-2xl font-bold text-purple-800">{{ lucro_total|floatformat:2 }} MT</div>
                </div>

            </div>
            <!-- Gráficos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Gráfico de Vendas -->
                <div class="bg-white rounded-lg shadow-sm border border-pharmacy-gray p-6" id="sales-chart-container">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Vendas por Período</h3>
                    <div class="h-64" id="sales-chart">
                        <!-- Gráfico será renderizado pelo JavaScript -->
                        <div class="flex items-center justify-center h-full text-gray-500">
                            Carregando gráfico...
                        </div>
                    </div>
                </div>

                <!-- Gráfico de Rentabilidade -->
                <div class="bg-white rounded-lg shadow-sm border border-pharmacy-gray p-6" id="profit-chart-container">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Rentabilidade por Categoria</h3>
                    <div class="h-64" id="profit-chart">
                        <!-- Gráfico será renderizado pelo JavaScript -->
                        <div class="flex items-center justify-center h-full text-gray-500">
                            Carregando gráfico...
                        </div>
                    </div>
                </div>
            </div>


            <!-- Tabela de Relatórios -->
            <div class="bg-white rounded-lg shadow-sm border border-pharmacy-gray overflow-hidden"
                 id="report-table-container">
                <div class="px-6 py-4 border-b border-pharmacy-gray">
                    <h3 class="text-lg font-semibold text-gray-900">
                        Vendas por Período - {{ data_inicio }} a {{ data_fim }}
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-pharmacy-gray-light">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Data</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Vendas (MT)</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Custo (MT)</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Lucro (MT)</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Margem</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Atendente</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Status</th>
                        </tr>
                        </thead>
                        <tbody class="divide-y divide-pharmacy-gray">
                        {% for linha in dados_tabela %}
                        <tr class="hover:bg-pharmacy-gray-light/50 transition-colors">
                            <td class="px-6 py-4 text-sm text-gray-900">{{ linha.data }}</td>
                            <td class="px-6 py-4 text-sm font-medium text-gray-900">{{ linha.vendas|floatformat:2 }}</td>
                            <td class="px-6 py-4 text-sm text-gray-600">{{ linha.custo|floatformat:2 }}</td>
                            <td class="px-6 py-4 text-sm font-medium text-green-600">{{ linha.lucro|floatformat:2 }}</td>
                            <td class="px-6 py-4">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if linha.status_cor == 'green' %}bg-green-100 text-green-800
                                    {% elif linha.status_cor == 'yellow' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ linha.margem|floatformat:1 }}%
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-900">{{ linha.atendente }}</td>
                            <td class="px-6 py-4">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if linha.status_cor == 'green' %}bg-green-100 text-green-800
                                    {% elif linha.status_cor == 'yellow' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-red-100 text-red-800{% endif %}">
                                    <i class="mr-1">
                                        {% if linha.status_cor == 'green' %}
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd"></path>
                                        </svg>
                                        {% elif linha.status_cor == 'yellow' %}
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd"></path>
                                        </svg>
                                        {% else %}
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                        </svg>
                                        {% endif %}
                                    </i>
                                    {{ linha.status }}
                                </span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                Nenhum dado encontrado para o período selecionado
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="px-6 py-4 bg-pharmacy-gray-light border-t border-pharmacy-gray">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">Total do período:</span>
                        <div class="flex space-x-6">
                            <span class="font-medium text-gray-900">Vendas: {{ faturamento_total|floatformat:2 }} MT</span>
                            <span class="font-medium text-gray-900">Custo: {{ custo_total|floatformat:2 }} MT</span>
                            <span class="font-medium text-green-600">Lucro: {{ lucro_total|floatformat:2 }} MT</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Incluir Highcharts -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <script>
    // Dados dos gráficos com fallback seguro
    const dadosVendas = {{ dados_grafico_vendas|safe }};
    const dadosRentabilidade = {{ dados_grafico_rentabilidade|safe }};

    // Função para inicializar gráficos
    function inicializarGraficos() {
        try {
            // Gráfico de Vendas
            if (dadosVendas && dadosVendas.categories && dadosVendas.series) {
                Highcharts.chart('sales-chart', {
                    chart: {
                        type: 'column',
                        height: 256
                    },
                    title: { text: null },
                    xAxis: {
                        categories: dadosVendas.categories,
                        crosshair: true
                    },
                    yAxis: {
                        min: 0,
                        title: { text: 'Vendas (MT)' }
                    },
                    tooltip: {
                        valuePrefix: 'MT '
                    },
                    series: dadosVendas.series,
                    exporting: { enabled: false },
                    credits: { enabled: false }
                });
            } else {
                document.getElementById('sales-chart').innerHTML =
                    '<div class="flex items-center justify-center h-full text-gray-500">Dados não disponíveis</div>';
            }

            // Gráfico de Rentabilidade
            if (dadosRentabilidade && dadosRentabilidade.series) {
                Highcharts.chart('profit-chart', {
                    chart: {
                        type: 'pie',
                        height: 256
                    },
                    title: { text: null },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '<b>{point.name}</b>: MT {point.y:.2f}'
                            }
                        }
                    },
                    tooltip: {
                        pointFormat: 'Lucro: <b>MT {point.y:.2f}</b>'
                    },
                    series: dadosRentabilidade.series,
                    exporting: { enabled: false },
                    credits: { enabled: false }
                });
            } else {
                document.getElementById('profit-chart').innerHTML =
                    '<div class="flex items-center justify-center h-full text-gray-500">Dados não disponíveis</div>';
            }

        } catch (error) {
            console.error('Erro ao carregar gráficos:', error);
            document.getElementById('sales-chart').innerHTML =
                '<div class="flex items-center justify-center h-full text-red-500">Erro ao carregar gráfico</div>';
            document.getElementById('profit-chart').innerHTML =
                '<div class="flex items-center justify-center h-full text-red-500">Erro ao carregar gráfico</div>';
        }
    }

    // Inicializar gráficos quando a página carregar
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializarGraficos);
    } else {
        inicializarGraficos();
    }

    // Funções de exportação
    function exportarPDF() {
        // Usando a funcionalidade nativa do Highcharts
        const chart1 = Highcharts.charts[0];
        const chart2 = Highcharts.charts[1];

        if (chart1) {
            chart1.exportChart({
                type: 'application/pdf',
                filename: 'relatorio-vendas'
            });
        }
    }

    function imprimirRelatorio() {
        window.print();
    }

    // Mostrar loading ao submeter formulário
    document.querySelector('form').addEventListener('submit', function() {
        document.getElementById('sales-chart').innerHTML =
            '<div class="flex items-center justify-center h-full text-gray-500">Carregando...</div>';
        document.getElementById('profit-chart').innerHTML =
            '<div class="flex items-center justify-center h-full text-gray-500">Carregando...</div>';
    });

    // Adicionar confirmação antes de imprimir
    function imprimirRelatorio() {
        if (confirm('Deseja imprimir este relatório?')) {
            window.print();
        }
    }
</script>
    <style>
        @media print {
            .flex { display: block !important; }
            .ml-64 { margin-left: 0 !important; }
            #filters-section, #export-pdf-btn, #print-btn { display: none !important; }
            .bg-white { background: white !important; }
            .shadow-sm { box-shadow: none !important; }
        }
    </style>

{% endblock %}