{% extends 'main.html' %}
{% block content %}

{% include 'navbar.html' %}

<div class="flex-1 ml-64 p-8" id="main-content">
    <div class="mb-8" id="page-header">
        <div class="flex items-center mb-4">
            <button onclick="window.history.back()"
                    class="text-gray-500 hover:text-gray-700 mr-4 transition-colors">
                <i class="text-lg">
                    <svg aria-hidden="true" class="w-5 h-5" viewBox="0 0 448 512">
                        <path d="M9.4 233.4c-12.5 12.5-12.5 32.8
                    0 45.3l160 160c12.5 12.5 32.8 12.5
                    45.3 0s12.5-32.8 0-45.3L109.2
                    288H416c17.7 0 32-14.3
                    32-32s-14.3-32-32-32H109.2l105.5-105.4c12.5-12.5
                    12.5-32.8 0-45.3s-32.8-12.5-45.3
                    0l-160 160z" fill="currentColor"/>
                    </svg>
                </i>
            </button>
            <div>
                <h2 class="text-xl font-bold text-gray-900 mb-2">{% if lote %}Editar Lote{% else %}Novo Lote{% endif %}</h2>
                <p class="text-gray-600">{% if lote %}Atualize os dados do lote{% else %}Cadastre um novo lote de produto{% endif %}</p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-pharmacy-gray p-8">
        <form method="post" id="lote-form">
            {% csrf_token %}

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Produto -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Produto <span
                            class="text-red-500">*</span></label>
                    <select name="produto" id="produto-select" required
                            class="w-full px-4 py-3 border rounded-lg border-pharmacy-gray focus:ring-2 focus:ring-pharmacy-green focus:outline-none">
                        <option value="">Selecione um produto</option>
                        {% for produto in produtos %}
                            <option value="{{ produto.id }}"
                                    {% if lote and lote.produto.id == produto.id %}selected{% endif %}
                                    data-carteiras-por-caixa="{{ produto.carteiras_por_caixa|default:1 }}">
                                {{ produto.nome }}
                                {% if produto.carteiras_por_caixa and produto.carteiras_por_caixa > 1 %}
                                    ({{ produto.carteiras_por_caixa }} carteiras/caixa)
                                {% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Número do Lote será inserido automaticamente</label>
                    {% if lote %}
                    <div>
                        <input type="text" value="{{ lote.numero_lote }}"
                               class="w-full px-4 py-3 border rounded-lg border-pharmacy-gray bg-gray-100 cursor-not-allowed"
                               readonly>
                    </div>
                {% endif %}
                </div>


                <!-- Caixas -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Quantidade de Caixas</label>
                    <input type="number" min="0" name="nr_caixas" id="nr_caixas"
                           value="{{ lote.nr_caixas|default:0 }}"
                           class="w-full px-4 py-3 border rounded-lg border-pharmacy-gray focus:ring-2 focus:ring-pharmacy-green focus:outline-none quantity-input"
                           placeholder="0">
                    <p class="text-xs text-gray-500 mt-1" id="caixas-info">
                        Informe a quantidade de caixas completas
                    </p>
                </div>

                <!-- Carteiras -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Quantidade de Carteiras Avulsas</label>
                    <input type="number" min="0" name="nr_carteiras" id="nr_carteiras"
                           value="{{ lote.nr_carteiras|default:0 }}"
                           class="w-full px-4 py-3 border rounded-lg border-pharmacy-gray focus:ring-2 focus:ring-pharmacy-green focus:outline-none quantity-input"
                           placeholder="0">
                    <p class="text-xs text-gray-500 mt-1" id="carteiras-info">
                        Informe carteiras avulsas (fora das caixas)
                    </p>
                </div>

                <!-- Data de validade -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Data de Validade <span
                            class="text-red-500">*</span></label>
                    <input type="date" name="data_validade" required
                           value="{{ lote.data_validade|date:'Y-m-d'|default:'' }}"
                           class="w-full px-4 py-3 border rounded-lg border-pharmacy-gray focus:ring-2 focus:ring-pharmacy-green focus:outline-none"
                           min="{{ today|date:'Y-m-d' }}">
                    <p class="text-xs text-gray-500 mt-1">Data até quando o produto pode ser vendido</p>
                </div>

                <!-- Data de fabricação -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Data de Fabricação</label>
                    <input type="date" name="data_fabricacao"
                           value="{{ lote.data_fabricacao|date:'Y-m-d'|default:'' }}"
                           class="w-full px-4 py-3 border rounded-lg border-pharmacy-gray focus:ring-2 focus:ring-pharmacy-green focus:outline-none"
                           max="{{ today|date:'Y-m-d' }}">
                    <p class="text-xs text-gray-500 mt-1">Data quando o produto foi fabricado (opcional)</p>
                </div>
            </div>

            <!-- Resumo do cálculo -->
            <div id="resumo-calculado" class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200 hidden">
                <h3 class="font-semibold text-blue-800 mb-2">Resumo do Estoque</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div>
                        <span class="font-medium">Total em Unidades:</span>
                        <span id="total-unidades" class="ml-2 font-bold text-blue-700">0</span>
                    </div>
                    <div>
                        <span class="font-medium">Equivalente em:</span>
                        <span id="equivalente-caixas" class="ml-2 text-blue-600">0 caixas + 0 carteiras</span>
                    </div>
                    <div>
                        <span class="font-medium">Produto Selecionado:</span>
                        <span id="info-produto" class="ml-2 text-blue-600">-</span>
                    </div>
                </div>
            </div>

            <!-- Mensagens de validação -->
            <div id="mensagem-validacao" class="mt-4 p-3 rounded-lg hidden">
                <p id="texto-validacao" class="text-sm font-medium"></p>
            </div>

            <!-- Botões -->
            <div class="flex justify-end space-x-4 mt-8 pt-6 border-t border-pharmacy-gray">
                <a href="{% url 'listar_lotes' %}"
                   class="px-6 py-3 border border-pharmacy-gray text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium flex items-center">
                    Cancelar
                </a>
                <button type="submit" id="submit-btn"
                        class="px-6 py-3 bg-pharmacy-green hover:bg-pharmacy-green-dark text-white rounded-lg transition-colors font-medium flex items-center shadow-lg">
                    <svg class="mr-2 w-5 h-5" viewBox="0 0 448 512" fill="currentColor">
                        <path d="M438.6 105.4c12.5 12.5
                    12.5 32.8 0 45.3l-256 256c-12.5
                    12.5-32.8 12.5-45.3
                    0l-128-128c-12.5-12.5-12.5-32.8
                    0-45.3s32.8-12.5 45.3 0L160
                    338.7 393.4 105.4c12.5-12.5
                    32.8-12.5 45.3 0z"/>
                    </svg>
                    {% if lote %}Atualizar Lote{% else %}Salvar Lote{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const produtoSelect = document.getElementById('produto-select');
    const nrCaixasInput = document.getElementById('nr_caixas');
    const nrCarteirasInput = document.getElementById('nr_carteiras');
    const resumoDiv = document.getElementById('resumo-calculado');
    const totalUnidadesSpan = document.getElementById('total-unidades');
    const equivalenteCaixasSpan = document.getElementById('equivalente-caixas');
    const infoProdutoSpan = document.getElementById('info-produto');
    const mensagemValidacaoDiv = document.getElementById('mensagem-validacao');
    const textoValidacao = document.getElementById('texto-validacao');
    const submitBtn = document.getElementById('submit-btn');
    const caixasInfo = document.getElementById('caixas-info');
    const carteirasInfo = document.getElementById('carteiras-info');

    let carteirasPorCaixa = 1;
    let produtoSelecionado = null;

    // Atualiza informações quando produto é selecionado
    produtoSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        carteirasPorCaixa = parseInt(selectedOption.getAttribute('data-carteiras-por-caixa')) || 1;
        produtoSelecionado = selectedOption.text;

        // Atualiza informações do produto
        infoProdutoSpan.textContent = selectedOption.text;
        caixasInfo.textContent = `Cada caixa contém ${carteirasPorCaixa} carteiras`;
        carteirasInfo.textContent = `Carteiras avulsas (menos de ${carteirasPorCaixa} unidades)`;

        calcularResumo();
    });

    // Calcula resumo quando quantidades mudam
    function calcularResumo() {
        const caixas = parseInt(nrCaixasInput.value) || 0;
        const carteiras = parseInt(nrCarteirasInput.value) || 0;

        // Calcula total em unidades
        const totalUnidades = (caixas * carteirasPorCaixa) + carteiras;

        // Calcula equivalente em caixas/carteiras
        const caixasEquivalentes = Math.floor(totalUnidades / carteirasPorCaixa);
        const carteirasEquivalentes = totalUnidades % carteirasPorCaixa;

        // Atualiza display
        totalUnidadesSpan.textContent = totalUnidades.toLocaleString('pt-BR');
        equivalenteCaixasSpan.textContent = `${caixasEquivalentes} caixas + ${carteirasEquivalentes} carteiras`;

        // Mostra/oculta resumo
        if (totalUnidades > 0 && produtoSelecionado) {
            resumoDiv.classList.remove('hidden');
        } else {
            resumoDiv.classList.add('hidden');
        }

        // Validações
        validarFormulario(caixas, carteiras, totalUnidades);
    }

    // Validações do formulário
    function validarFormulario(caixas, carteiras, totalUnidades) {
        let mensagens = [];
        let tipoMensagem = 'warning'; // warning, error, success

        // Validações básicas
        if (caixas < 0 || carteiras < 0) {
            mensagens.push("Valores não podem ser negativos");
            tipoMensagem = 'error';
        }

        if (totalUnidades === 0) {
            mensagens.push("Informe pelo menos caixas ou carteiras");
            tipoMensagem = 'warning';
        }

        if (carteiras >= carteirasPorCaixa) {
            mensagens.push(`Carteiras avulsas (${carteiras}) devem ser menores que ${carteirasPorCaixa}. Considere converter em caixas.`);
            tipoMensagem = 'warning';
        }

        // Atualiza mensagem de validação
        if (mensagens.length > 0) {
            textoValidacao.textContent = mensagens.join('. ');
            mensagemValidacaoDiv.className = `mt-4 p-3 rounded-lg ${
                tipoMensagem === 'error' ? 'bg-red-100 border border-red-300 text-red-700' :
                tipoMensagem === 'warning' ? 'bg-yellow-100 border border-yellow-300 text-yellow-700' :
                'bg-green-100 border border-green-300 text-green-700'
            }`;
            mensagemValidacaoDiv.classList.remove('hidden');

            // Desabilita submit se for erro
            submitBtn.disabled = (tipoMensagem === 'error');
            submitBtn.classList.toggle('opacity-50', tipoMensagem === 'error');
            submitBtn.classList.toggle('cursor-not-allowed', tipoMensagem === 'error');
        } else {
            mensagemValidacaoDiv.classList.add('hidden');
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }

    // Event listeners para inputs de quantidade
    nrCaixasInput.addEventListener('input', calcularResumo);
    nrCarteirasInput.addEventListener('input', calcularResumo);

    // Inicializa Select2 se disponível
    if (typeof $.fn.select2 !== 'undefined') {
        $('#produto-select').select2({
            placeholder: 'Selecione ou busque um produto',
            allowClear: true
        });
    }

    // Calcula resumo inicial se editando
    {% if lote %}
    setTimeout(() => {
        produtoSelect.dispatchEvent(new Event('change'));
    }, 100);
    {% endif %}

    // Previne envio se houver erro
    document.getElementById('lote-form').addEventListener('submit', function(e) {
        const caixas = parseInt(nrCaixasInput.value) || 0;
        const carteiras = parseInt(nrCarteirasInput.value) || 0;

        if (caixas < 0 || carteiras < 0) {
            e.preventDefault();
            alert('Valores não podem ser negativos');
            return false;
        }

        if ((caixas === 0 && carteiras === 0) || !produtoSelect.value) {
            e.preventDefault();
            alert('Preencha todos os campos obrigatórios');
            return false;
        }
    });
});
</script>

<style>
.quantity-input:focus {
    border-color: #10B981;
    box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
}

.hidden {
    display: none;
}

/* Estilos para Select2 personalizado */
.select2-container--default .select2-selection--single {
    border: 1px solid #D1D5DB;
    border-radius: 0.5rem;
    height: 48px;
    padding: 0.5rem 0.75rem;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 46px;
}
</style>

{% endblock %}
